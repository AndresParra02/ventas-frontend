<script>
async function consultarVentas() {
  const cedula = document.getElementById("cedula").value.trim();
  if (!cedula) {
    alert("Por favor ingrese una c√©dula");
    return;
  }

  try {
    const res = await fetch(`https://ventas-backend-loic.onrender.com/ventas/${cedula}`);
    if (!res.ok) throw new Error("Error en la consulta");

    const data = await res.json();
    const tabla = document.getElementById("tablaVentas");
    const resumenDiv = document.getElementById("resumenVentas");

    tabla.innerHTML = "";
    resumenDiv.innerHTML = "";

    if (data.length === 0) {
      tabla.innerHTML = `
        <tr>
          <td colspan="9" style="text-align:center;">
            No se encontraron ventas
          </td>
        </tr>`;
      return;
    }

    // üîπ Llenar tabla con NUEVA estructura
    data.forEach(v => {
      tabla.innerHTML += `
        <tr>
          <td>${v.cedula_asesor}</td>
          <td>${v.nombre_asesor}</td>
          <td>${v.rut}</td>
          <td>${v.nombre_cliente}</td>
          <td>${v.estado_venta}</td>
          <td>${new Date(v.fecha_venta).toLocaleDateString()}</td>
          <td>${v.fecha_activacion ? new Date(v.fecha_activacion).toLocaleDateString() : '-'}</td>
          <td>${v.tel_contacto}</td>
          <td>${v.tipo_venta}</td>
        </tr>
      `;
    });

    // üîπ Resumen por estado de venta
    const resumen = {};
    let totalVentas = 0;

    data.forEach(v => {
      totalVentas++;
      resumen[v.estado_venta] = (resumen[v.estado_venta] || 0) + 1;
    });

    Object.keys(resumen).forEach(estado => {
      resumenDiv.innerHTML += `
        <div class="resumen-card">
          <h3>${estado}</h3>
          <p>${resumen[estado]}</p>
        </div>
      `;
    });

    resumenDiv.innerHTML += `
      <div class="resumen-card" style="background-color:#2ecc71;">
        <h3>Total Ventas</h3>
        <p>${totalVentas}</p>
      </div>
    `;

  } catch (err) {
    alert("Ocurri√≥ un error al consultar las ventas");
    console.error(err);
  }
}
</script>
